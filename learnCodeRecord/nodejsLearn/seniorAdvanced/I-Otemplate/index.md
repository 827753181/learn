# 什么是 I/O 多路复用

# I/O 多路复用轮询技术 select 和 epoll 的区别？

## 阻塞 I/O 和非阻塞 I/O

阻塞 I/O 和非阻塞 I/O 是发生在等待资源阶段，根据发起 I/O 请求是否阻塞来判断  
阻塞 I/O ：这种模式下用户发起一个 I/O 操作后只有收到响应或者超时才会继续执行后续操作，否则 I/O 将会一直阻塞。以读取磁盘上的一段文件为例子，系统内核在完成磁盘寻道、读取数据、复制数据到内存中，这个调用才会完成。阻塞的这段时间对 CPU 资源是浪费的。
非阻塞 I/O ：这种模式下用户发起一个 I/O 操作后，如果数据没有就位，会立即返回（标志数据不可用），此时 CPU 时间片可以用来做一些其它事情。

## 同步 I/O 和异步 I/O

同步和异步 I/O 发生在使用资源阶段，根据实际 I/O 操作来判断
同步 I/O：应用发送或接收数据后，如果不反悔，继续等待（阻塞），直到数据成功或失败返回
异步 I/O：应用发送或接收数据后立即返回，数据写入 OS 缓存，由 OS 完成数据发送或接受，并返回成功或失败的信息给应用。Node.js 就是典型的异步编程例子。

## I/O 多路复用的四种实现

I/O 多路服用有多种实现模式：select、poll、epoll、kqueue

- select
  通过轮询检查在文件描述符上设置的标识位来进行判断，select 的轮询相当于在数据库中查找一条记录没有建立索引，对所有的 socket 进行全部遍历，这对 CPU 是浪费的。另外 select 还有一个限制，对于单个进程所能打开的文件描述符最大只能是 1024，那么基于 select 的轮询技术最多也只能很好的处理 1000 并发的吞吐量，可以查看 上一个 10 年，著名的 C10K 并发连接问题

- poll
  poll 和 select 在实现上没有本质的区别，相比较 select，poll 基于链表来实现，没有了最大链接 1024 的限制。但是当文件描述符多了之后，每次调用都会对链接进行线性遍历，性能还是十分低下的。

- epoll
  是 linux 下效率最高的 I/O 事件通知机制，没有最大链接限制，通过 callbak 回调通知机制，不在是每次调用都对链接进行线性遍历，这样就不会随着文件描述符的增加导致效率下降。

在 1GB 内存的机器上能监听大约 10 万个端口，远超过 select 的 1024 限制，具体可以在服务器上查看 cat /proc/sys/fs/file-max

- kqueue
  与 epoll 类似，仅存于 FreeBSD（一种类 UNIX 操作系统）。

## 白话风格讲解 I/O 模型的演进

- 同步阻塞 I/O 模式
  小明电话相约妹子在校门口，然后小明很专一、不见到妹子不回家，期间没有做任何事情，一直在等待！

- 同步非阻塞 I/O 模式
  小明电话相约妹子在校门口，妹子还没准备好（出门前化妆几小时。。。），这时候的小明很执着，每隔一会儿给妹子发个信息直到妹子准备好了。

- I/O 多路复用模式
  select 小明电话相约妹子在校门口，委托门卫 select 大爷帮忙，select 大爷很敬业每出去一个人都会进行询问，但是 select 大爷有个限制最多只能询问 1024 个。
  poll poll 类似于 select 功能，不同的是 poll 大爷没有 1024 限制，可以一直坚持，但是当 poll 大爷超过 1024，询问的越来越多之后就显得越来越精疲力尽了。
  epoll 小明电话相约妹子在校门口，委托门卫 epoll 大爷帮忙，epoll 大爷不在是每个询问，规定每个人出入校门必须带上学生证，这样 opoll 大爷就是知道哪个是小明的女神了，epoll 大爷找到女神之后在电话通知小明。
- 信号驱动 I/O 模式
  小明电话相约妹子在校门口，此时妹子回复说我还没准备好（出门前化妆几小时。。。），这个时候小明也没去，而是先去干其它事情了，等妹子准备好之后电话通知小明，我已经准备好了，小明这个时候才去校门口等着和妹子的约会。

- 异步 I/O 模式
  小明告诉妹子我们在校园门口相约，之后小明没有在那干等了，而是先回宿舍休息会或者和朋友在打会球等等，妹子到校门口之后电话通知小明，我已经来啦。
